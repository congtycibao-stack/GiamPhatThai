<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kh·∫£o s√°t Di chuy·ªÉn - CI BAO CO., LTD</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        /* CSS GIAO DI·ªÜN CHU·∫®N */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef2f7; margin: 0; padding: 0; color: #333; }
        .container { max-width: 500px; margin: 20px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: none; }
        .company-header { text-align: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 20px; }
        .company-name { font-size: 18px; font-weight: 800; color: #2c3e50; text-transform: uppercase; margin: 0; letter-spacing: 1px; }
        .form-title { font-size: 16px; font-weight: 700; color: #007bff; margin: 10px 0 0; text-transform: uppercase; }
        .form-desc { font-size: 13px; color: #666; margin-top: 5px; font-style: italic; }
        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #444; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #d1d9e6; border-radius: 8px; box-sizing: border-box; font-size: 15px; transition: 0.3s; }
        .select2-container .select2-selection--single { height: 45px !important; border: 1px solid #d1d9e6 !important; border-radius: 8px !important; padding: 8px; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { top: 10px !important; }
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background-color: #007bff; color: white; box-shadow: 0 4px 10px rgba(0,123,255,0.3); }
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; z-index: 10; display: none; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 0 0 8px 8px; }
        .suggestion-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .suggestion-item:hover { background-color: #f8f9fa; color: #007bff; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 999; display: flex; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .popup-card { background: white; padding: 30px; border-radius: 15px; max-width: 450px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.2); animation: popIn 0.3s ease-out; }
        .popup-icon { font-size: 50px; margin-bottom: 15px; display: block; }
        .popup-title { font-size: 20px; font-weight: 800; color: #2c3e50; margin: 0 0 10px; }
        .popup-text { font-size: 14px; color: #555; line-height: 1.6; margin-bottom: 25px; text-align: justify; }
        .popup-btn { background: #28a745; color: white; width: 100%; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: bold; border: none; cursor: pointer; }
        .hidden { display: none !important; }
        
        /* CSS M·ªöI CHO H·ªòP C·∫¢NH B√ÅO */
        .alert-box {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 14px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div id="welcomeScreen" class="overlay">
        <div class="popup-card">
            <span class="popup-icon">üõ°Ô∏è</span>
            <h3 class="popup-title">TH√îNG B√ÅO QUAN TR·ªåNG</h3>
            <div class="popup-text">
                Ch√†o m·ª´ng Qu√Ω CBNV C√¥ng ty <b>CI BAO</b>.<br><br>
                Th·ª±c hi·ªán quy ƒë·ªãnh c·ªßa Lu·∫≠t B·∫£o v·ªá M√¥i tr∆∞·ªùng, c√¥ng ty c·∫ßn thu th·∫≠p d·ªØ li·ªáu qu√£ng ƒë∆∞·ªùng di chuy·ªÉn c·ªßa nh√¢n vi√™n ƒë·ªÉ t√≠nh to√°n <b>Ki·ªÉm k√™ Kh√≠ nh√† k√≠nh (Ph·∫°m vi 3)</b>.<br><br>
                
                <b>üîí CAM K·∫æT B·∫¢O M·∫¨T:</b><br>
                Ch√∫ng t√¥i hi·ªÉu r·∫±ng ƒë·ªãa ch·ªâ l√† th√¥ng tin c√° nh√¢n quan tr·ªçng. C√¥ng ty cam k·∫øt d·ªØ li·ªáu n√†y <b>ch·ªâ ƒë∆∞·ª£c s·ª≠ d·ª•ng n·ªôi b·ªô</b> cho m·ª•c ƒë√≠ch m√¥i tr∆∞·ªùng, tuy·ªát ƒë·ªëi kh√¥ng chia s·∫ª cho b√™n th·ª© ba.<br><br>
                
                <div style="background:#e8f5e9; padding:15px; border-radius:8px; font-size:14px; border-left:5px solid #28a745; text-align: left;">
                    <b>‚ú® H·ªñ TR·ª¢ T·ª∞ ƒê·ªòNG:</b><br>
                    ƒê·ªÉ thu·∫≠n ti·ªán cho b·∫°n, h·ªá th·ªëng s·∫Ω <b>T·ª∞ ƒê·ªòNG ƒêI·ªÄN ƒê·ªäA CH·ªà</b> d·ª±a tr√™n h·ªì s∆° nh√¢n s·ª± c√≥ s·∫µn. B·∫°n ch·ªâ c·∫ßn ki·ªÉm tra l·∫°i v√† x√°c nh·∫≠n.
                </div>
            </div>
            <button class="popup-btn" onclick="document.getElementById('welcomeScreen').classList.add('hidden'); document.getElementById('mainForm').style.display='block';">T√îI ƒê√É HI·ªÇU V√Ä ƒê·ªíNG √ù</button>
        </div>
    </div>

    <div id="successScreen" class="overlay hidden">
        <div class="popup-card">
            <span class="popup-icon">üåø</span>
            <h3 class="popup-title" style="color:#28a745">C·∫¨P NH·∫¨T TH√ÄNH C√îNG!</h3>
            <p class="popup-text" style="text-align: center;">D·ªØ li·ªáu c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n.<br>C·∫£m ∆°n b·∫°n ƒë√£ ƒë√≥ng g√≥p cho m·ª•c ti√™u Xanh c·ªßa c√¥ng ty!</p>
            <button class="popup-btn" style="background:#007bff" onclick="location.reload()">ƒê√ìNG V√Ä QUAY L·∫†I</button>
        </div>
    </div>

    <div id="mainForm" class="container">
        <div class="company-header">
            <h1 class="company-name">C√îNG TY TNHH CI BAO</h1>
            <h2 class="form-title">PHI·∫æU THU TH·∫¨P TH√îNG TIN DI CHUY·ªÇN</h2>
            <p class="form-desc">(Ph·ª•c v·ª• Ki·ªÉm k√™ Kh√≠ nh√† k√≠nh - GHG Inventory)</p>
        </div>
        <div class="form-group">
            <label>üîç T√¨m ki·∫øm nh√¢n s·ª±:</label>
            <input type="text" id="searchInput" placeholder="Nh·∫≠p M√£ th·∫ª ho·∫∑c H·ªç t√™n..." autocomplete="off">
            <div class="suggestions" id="suggestionBox"></div>
        </div>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px dashed #ccc; margin-bottom: 20px;">
            <div class="form-group" style="margin-bottom: 10px;"><label style="font-size:12px;">M√£ Nh√¢n Vi√™n:</label><input type="text" id="staffCode" readonly style="background-color: #e9ecef; font-weight:bold;"></div>
            <div class="form-group" style="margin-bottom: 0;"><label style="font-size:12px;">H·ªç T√™n:</label><input type="text" id="fullName" readonly style="background-color: #e9ecef; font-weight:bold;"></div>
        </div>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
        <div class="form-group">
            <label>üõµ Ph∆∞∆°ng ti·ªán ƒëi l√†m ch√≠nh:</label>
            <select id="vehicleType">
                <option value="Xe m√°y (XƒÉng)">Xe m√°y (XƒÉng)</option>
                <option value="Xe m√°y (ƒêi·ªán)">Xe m√°y (ƒêi·ªán)</option>
                <option value="√î t√¥ (XƒÉng)">√î t√¥ (XƒÉng)</option>
                <option value="√î t√¥ (D·∫ßu)">√î t√¥ (D·∫ßu)</option>
                <option value="Xe ƒë∆∞a r∆∞·ªõc">Xe ƒë∆∞a r∆∞·ªõc c√¥ng ty</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>üè† ƒê·ªãa ch·ªâ c∆∞ tr√∫ (T·ª± ƒë·ªông ƒëi·ªÅn):</label>
            
            <select id="province" style="width: 100%"><option value="">-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option></select>
            <div style="height: 10px;"></div>
            
            <select id="ward" style="width: 100%"><option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option></select>
            
            <input type="text" id="detailAddress" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng, ·∫•p/th√¥n/t·ªï..." style="margin-top: 15px;">
            
            <div class="alert-box">
                <span style="font-size: 20px;">‚ö†Ô∏è</span>
                <span>
                    <b>L∆ØU √ù QUAN TR·ªåNG:</b><br>
                    H·ªá th·ªëng t·ª± ƒë·ªông ƒëi·ªÅn c√≥ th·ªÉ ch∆∞a ch√≠nh x√°c 100%. Vui l√≤ng nh√¨n k·ªπ <b>T·ªânh</b> v√† <b>X√£/Ph∆∞·ªùng</b> ·ªü tr√™n. N·∫øu sai, h√£y b·∫•m v√†o ƒë·ªÉ ch·ªçn l·∫°i.
                </span>
            </div>

            <label style="margin-top:20px; color:#007bff;">Qu√£ng ƒë∆∞·ªùng 1 chi·ªÅu (Km):</label>
            <input type="number" id="distanceKm" placeholder="Nh·∫≠p s·ªë Km ∆∞·ªõc l∆∞·ª£ng (VD: 5.5)" step="0.1" style="font-weight:bold;">
        </div>
        
        <button id="submitBtn" class="btn-primary" onclick="submitForm()">G·ª¨I TH√îNG TIN üöÄ</button>
    </div>

<script>
    // --- 1. K·∫æT N·ªêI SERVER (SUPABASE) ---
    const SUPABASE_URL = 'https://gywuxyywloioxhbfybdl.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5d3V4eXl3bG9pb3hoYmZ5YmRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MTYyMDgsImV4cCI6MjA4Mjk5MjIwOH0.oCRTqibMzqfsGdaDkZ53inAoNR56QWDHQ3fWtmRqfIk';
    const { createClient } = window.supabase;
    const dbClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- 2. D·ªÆ LI·ªÜU ƒê·ªäA CH√çNH (ƒê·ªäNH NGHƒ®A DANH S√ÅCH X√É PH∆Ø·ªúNG) ---
    // Danh s√°ch ƒê·ªìng Nai chu·∫©n x√°c (nh∆∞ file b·∫°n cung c·∫•p)
    let FULL_DB = {
        "T·ªânh ƒê·ªìng Nai": [
            "Ph∆∞·ªùng Bi√™n Ho√†", "Ph∆∞·ªùng Tr·∫•n Bi√™n", "Ph∆∞·ªùng Tam Hi·ªáp", "Ph∆∞·ªùng Long B√¨nh", "Ph∆∞·ªùng Tr·∫£ng D√†i", "Ph∆∞·ªùng H·ªë Nai", "Ph∆∞·ªùng Long H∆∞ng", "X√£ ƒê·∫°i Ph∆∞·ªõc", "X√£ Nh∆°n Tr·∫°ch", "X√£ Ph∆∞·ªõc An", "X√£ Ph∆∞·ªõc Th√°i", "X√£ Long Ph∆∞·ªõc", "X√£ B√¨nh An", "X√£ Long Th√†nh", "X√£ An Ph∆∞·ªõc", "X√£ An Vi·ªÖn", "X√£ B√¨nh Minh", "X√£ Tr·∫£ng Bom", "X√£ B√†u H√†m", "X√£ H∆∞ng Th·ªãnh", "X√£ D·∫ßu Gi√¢y", "X√£ Gia Ki·ªám", "X√£ Th·ªëng Nh·∫•t", "Ph∆∞·ªùng B√¨nh L·ªôc", "Ph∆∞·ªùng B·∫£o Vinh", "Ph∆∞·ªùng Xu√¢n L·∫≠p", "Ph∆∞·ªùng Long Kh√°nh", "Ph∆∞·ªùng H√†ng G√≤n", "X√£ Xu√¢n Qu·∫ø", "X√£ Xu√¢n ƒê∆∞·ªùng", "X√£ C·∫©m M·ªπ", "X√£ S√¥ng Ray", "X√£ Xu√¢n ƒê√¥ng", "X√£ Xu√¢n ƒê·ªãnh", "X√£ Xu√¢n Ph√∫", "X√£ Xu√¢n L·ªôc", "X√£ Xu√¢n Ho√†", "X√£ Xu√¢n Th√†nh", "X√£ Xu√¢n B·∫Øc", "X√£ La Ng√†", "X√£ ƒê·ªãnh Qu√°n", "X√£ Ph√∫ Vinh", "X√£ Ph√∫ Ho√†", "X√£ T√† L√†i", "X√£ Nam C√°t Ti√™n", "X√£ T√¢n Ph√∫", "X√£ Ph√∫ L√¢m", "X√£ Tr·ªã An", "X√£ T√¢n An", "Ph∆∞·ªùng T√¢n Tri·ªÅu", "Ph∆∞·ªùng Tam Ph∆∞·ªõc", "Ph∆∞·ªùng Ph∆∞·ªõc T√¢n", "X√£ Thanh S∆°n", "X√£ ƒêak Lua", "X√£ Ph√∫ L√Ω", 
            "Ph∆∞·ªùng An B√¨nh", "Ph∆∞·ªùng An H√≤a", "Ph∆∞·ªùng B√¨nh ƒêa", "Ph∆∞·ªùng B·ª≠u H√≤a", "Ph∆∞·ªùng B·ª≠u Long", "Ph∆∞·ªùng H√≥a An", "Ph∆∞·ªùng H√≤a B√¨nh", "Ph∆∞·ªùng Long B√¨nh T√¢n", "Ph∆∞·ªùng Quang Vinh", "Ph∆∞·ªùng Quy·∫øt Th·∫Øng", "Ph∆∞·ªùng Tam H√≤a", "Ph∆∞·ªùng T√¢n Bi√™n", "Ph∆∞·ªùng T√¢n H·∫°nh", "Ph∆∞·ªùng T√¢n Hi·ªáp", "Ph∆∞·ªùng T√¢n H√≤a", "Ph∆∞·ªùng T√¢n Mai", "Ph∆∞·ªùng T√¢n Phong", "Ph∆∞·ªùng T√¢n Ti·∫øn", "Ph∆∞·ªùng T√¢n V·∫°n", "Ph∆∞·ªùng Thanh B√¨nh", "Ph∆∞·ªùng Th·ªëng Nh·∫•t", "Ph∆∞·ªùng Trung D≈©ng"
        ],
        "T·ªânh B√¨nh D∆∞∆°ng": ["Ph∆∞·ªùng Dƒ© An", "Ph∆∞·ªùng An B√¨nh", "Ph∆∞·ªùng T√¢n ƒê√¥ng Hi·ªáp", "Ph∆∞·ªùng ƒê√¥ng H√≤a", "Ph∆∞·ªùng T√¢n B√¨nh"],
        "Th√†nh ph·ªë H·ªì Ch√≠ Minh": ["Ph∆∞·ªùng B·∫øn Ngh√©", "Ph∆∞·ªùng B·∫øn Th√†nh", "Ph∆∞·ªùng 1", "Ph∆∞·ªùng 2", "Ph∆∞·ªùng 3", "Ph∆∞·ªùng 4", "Ph∆∞·ªùng 5"]
    };

    $(document).ready(function() {
        $('#province').select2({ placeholder: "-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --" });
        $('#ward').select2({ placeholder: "-- Ch·ªçn Ph∆∞·ªùng/X√£ --" });
        
        loadProvinceList(); 

        $('#province').on('select2:select', function (e) {
            loadWards(e.params.data.id);
        });
    });

    // H√†m n·∫°p danh s√°ch T·ªânh (Online + Offline)
    async function loadProvinceList() {
        try {
            const res = await fetch('https://raw.githubusercontent.com/kenzouno1/DiaGioiHanhChinhVN/master/data.json');
            const data = await res.json();
            data.forEach(tinh => {
                if (!FULL_DB[tinh.Name]) {
                    FULL_DB[tinh.Name] = [];
                    tinh.Districts.forEach(h => h.Wards.forEach(x => FULL_DB[tinh.Name].push(x.Name)));
                }
            });
        } catch (e) { console.log("Ch·∫°y ch·∫ø ƒë·ªô Offline (D·ªØ li·ªáu c·ª©ng)."); }

        let provHtml = '<option value="">-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option>';
        Object.keys(FULL_DB).sort().forEach(prov => {
            provHtml += `<option value="${prov}">${prov}</option>`;
        });
        document.getElementById('province').innerHTML = provHtml;
    }

    function loadWards(provinceName, selectedWard = null) {
        let wards = FULL_DB[provinceName] || [];
        wards.sort((a, b) => b.length - a.length); // X·∫øp t√™n d√†i l√™n tr∆∞·ªõc
        let wardHtml = '<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>';
        wards.forEach(w => { wardHtml += `<option value="${w}">${w}</option>`; });
        document.getElementById('ward').innerHTML = wardHtml;
        
        if (selectedWard) $('#ward').val(selectedWard).trigger('change');
        else $('#ward').val(null).trigger('change');
    }

    // --- 3. T√åM NH√ÇN VI√äN & T·ª∞ ƒê·ªòNG ƒêI·ªÄN ---
    const searchInput = document.getElementById('searchInput');
    const suggestionBox = document.getElementById('suggestionBox');

    searchInput.addEventListener('input', async (e) => {
        const keyword = e.target.value.trim();
        if (keyword.length < 2) { suggestionBox.style.display = 'none'; return; }
        
        // L·∫•y d·ªØ li·ªáu t·ª´ Supabase
        const { data } = await dbClient.from('employees').select('*')
            .or(`staff_code.ilike.%${keyword}%,full_name.ilike.%${keyword}%`).limit(5);

        if (data && data.length > 0) {
            suggestionBox.innerHTML = ''; suggestionBox.style.display = 'block';
            data.forEach(emp => {
                const div = document.createElement('div'); div.className = 'suggestion-item';
                div.textContent = `${emp.staff_code} - ${emp.full_name}`;
                div.onclick = () => { 
                    document.getElementById('staffCode').value = emp.staff_code; 
                    document.getElementById('fullName').value = emp.full_name; 
                    searchInput.value = ''; 
                    suggestionBox.style.display = 'none';
                    
                    // --- KI·ªÇM TRA & T·ª∞ ƒê·ªòNG ƒêI·ªÄN ---
                    if (!emp.full_address || emp.full_address.trim() === "") {
                        alert("‚ö†Ô∏è C·∫£nh b√°o: H·ªá th·ªëng ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªãa ch·ªâ c·ªßa nh√¢n vi√™n n√†y.\n(C√≥ th·ªÉ do Admin ch∆∞a n·∫°p l·∫°i danh s√°ch m·ªõi).\nVui l√≤ng nh·∫≠p th·ªß c√¥ng.");
                    } else {
                        autoFillAddress(emp.full_address);
                    }
                };
                suggestionBox.appendChild(div);
            });
        } else { suggestionBox.style.display = 'none'; }
    });

    // --- 4. H√ÄM ROBOT T√ÅCH CHU·ªñI ƒê·ªäA CH·ªà (TH√îNG MINH) ---
    function removeAccents(str) {
        if(!str) return "";
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                  .replace(/ƒë/g, "d").replace(/ƒê/g, "D").toUpperCase();
    }

    function autoFillAddress(fullString) {
        // V√≠ d·ª• input: "SN 37B, ·∫§P 4, PH·ªê 4, PH√ö H√íA, ƒê·ªíNG NAI"
        let searchStr = removeAccents(fullString);
        let foundProv = "";
        let foundWard = "";
        
        // B1: T√¨m T·ªânh (∆Øu ti√™n ƒê·ªìng Nai)
        if (searchStr.includes("DONG NAI")) foundProv = "T·ªânh ƒê·ªìng Nai";
        else {
            for (const prov in FULL_DB) {
                // So s√°nh t√™n t·ªânh (b·ªè ch·ªØ T·ªânh/Th√†nh ph·ªë)
                let provClean = removeAccents(prov).replace("TINH ", "").replace("THANH PHO ", "");
                if (searchStr.includes(provClean)) {
                    foundProv = prov; break;
                }
            }
        }

        if (foundProv) {
            // Ch·ªçn T·ªânh tr√™n giao di·ªán
            $('#province').val(foundProv).trigger('change');
            
            // B2: T√¨m X√£ (Qu√©t trong danh s√°ch x√£ c·ªßa t·ªânh ƒë√≥)
            const wards = FULL_DB[foundProv] || [];
            
            for (const w of wards) {
                // T·∫°o t√™n x√£ r√∫t g·ªçn ƒë·ªÉ so s√°nh (VD: "X√£ Ph√∫ H√≤a" -> "PHU HOA")
                let wClean = removeAccents(w).replace("XA ", "").replace("PHUONG ", "").replace("THI TRAN ", "");
                
                // Ki·ªÉm tra xem trong ƒë·ªãa ch·ªâ nh√¢n vi√™n c√≥ ch·ª©a t√™n x√£ n√†y kh√¥ng
                if (searchStr.includes(wClean)) {
                    foundWard = w;
                    break;
                }
            }

            if (foundWard) {
                // Ch·ªçn X√£ tr√™n giao di·ªán
                loadWards(foundProv, foundWard);
                
                // B3: T√°ch l·∫•y ph·∫ßn chi ti·∫øt (C·∫Øt b·ªè T·ªânh v√† X√£ ra kh·ªèi chu·ªói g·ªëc)
                let detail = fullString;
                
                // X√≥a T·ªânh (D√πng Regex)
                let provKey = foundProv.replace("T·ªânh ", "").replace("Th√†nh ph·ªë ", "");
                detail = detail.replace(new RegExp(provKey, 'gi'), "").replace(/ƒê·ªíNG NAI/gi, "").replace(/T·ªânh/gi, "").replace(/Th√†nh ph·ªë/gi, "");
                
                // X√≥a X√£
                let wardKey = foundWard.replace("X√£ ", "").replace("Ph∆∞·ªùng ", "");
                detail = detail.replace(new RegExp(wardKey, 'gi'), "").replace(/X√£/gi, "").replace(/Ph∆∞·ªùng/gi, "");
                
                // L√†m s·∫°ch d·∫•u ph·∫©y d∆∞ th·ª´a
                detail = detail.replace(/,\s*$/, "").replace(/^,\s*/, "") // X√≥a ph·∫©y ƒë·∫ßu/cu·ªëi
                               .replace(/,\s*,/g, ",") // X√≥a ph·∫©y k√©p
                               .trim();
                
                document.getElementById('detailAddress').value = detail;
            } else {
                // T√¨m th·∫•y T·ªânh nh∆∞ng kh√¥ng th·∫•y X√£
                document.getElementById('detailAddress').value = fullString; 
                alert(`H·ªá th·ªëng ƒë√£ ch·ªçn ${foundProv}.\nNh∆∞ng kh√¥ng t√¨m th·∫•y t√™n X√£/Ph∆∞·ªùng kh·ªõp v·ªõi d·ªØ li·ªáu.\nVui l√≤ng ch·ªçn X√£/Ph∆∞·ªùng th·ªß c√¥ng.`);
            }
        } else {
            // Kh√¥ng t√¨m th·∫•y g√¨ c·∫£
            document.getElementById('detailAddress').value = fullString;
            alert("Kh√¥ng t·ª± ƒë·ªông nh·∫≠n di·ªán ƒë∆∞·ª£c ƒë·ªãa ch·ªâ.\nVui l√≤ng ch·ªçn th·ªß c√¥ng.");
        }
    }

    // --- 5. G·ª¨I FORM ---
    window.submitForm = async function() {
        const staffCode = document.getElementById('staffCode').value;
        const fullName = document.getElementById('fullName').value;
        const vehicle = document.getElementById('vehicleType').value;
        const dist = parseFloat(document.getElementById('distanceKm').value);
        const detail = document.getElementById('detailAddress').value;
        
        const p = document.getElementById('province');
        const w = document.getElementById('ward');
        
        if (!staffCode) return alert("Vui l√≤ng ch·ªçn nh√¢n vi√™n!");
        if (isNaN(dist) || dist <= 0) return alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë Km (∆∞·ªõc l∆∞·ª£ng t·ª´ nh√† ƒë·∫øn c√¥ng ty)!");
        if (!p.value || !w.value) return alert("Vui l√≤ng ch·ªçn T·ªânh v√† X√£!");
        if (!detail) return alert("Vui l√≤ng nh·∫≠p/ki·ªÉm tra ƒë·ªãa ch·ªâ chi ti·∫øt!");

        const pText = p.options[p.selectedIndex].text;
        const wText = w.options[w.selectedIndex].text;
        
        // Gh√©p ƒë·ªãa ch·ªâ ho√†n ch·ªânh
        const fullAddress = `${detail}, ${wText}, ${pText}`;

        const btn = document.getElementById('submitBtn');
        btn.innerText = "ƒêANG G·ª¨I...";
        btn.disabled = true;

        const { data: existingData } = await dbClient.from('emissions').select('id').eq('staff_code', staffCode);
        
        const payload = {
            staff_code: staffCode,
            full_name: fullName,
            vehicle_type: vehicle,
            address_string: fullAddress,
            distance_km: dist,
            working_days: 0,
            co2_total_kg: 0
        };

        let error = null;
        if (existingData && existingData.length > 0) {
            const { error: updateErr } = await dbClient.from('emissions').update(payload).eq('id', existingData[0].id);
            error = updateErr;
        } else {
            const { error: insertErr } = await dbClient.from('emissions').insert(payload);
            error = insertErr;
        }

        if (error) {
            alert("L·ªói: " + error.message);
            btn.innerText = "G·ª¨I TH√îNG TIN üöÄ";
            btn.disabled = false;
        } else {
            document.getElementById('mainForm').style.display = 'none';
            document.getElementById('successScreen').classList.remove('hidden');
        }
    }
</script>
</body>
</html>