<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kh·∫£o s√°t Di chuy·ªÉn - CI BAO CO., LTD</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        /* CSS GIAO DI·ªÜN CHUNG (GI·ªÆ NGUY√äN) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef2f7; margin: 0; padding: 0; color: #333; }
        .container { max-width: 500px; margin: 20px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: none; }
        .company-header { text-align: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 20px; }
        .company-name { font-size: 18px; font-weight: 800; color: #2c3e50; text-transform: uppercase; margin: 0; letter-spacing: 1px; }
        .form-title { font-size: 16px; font-weight: 700; color: #007bff; margin: 10px 0 0; text-transform: uppercase; }
        .form-desc { font-size: 13px; color: #666; margin-top: 5px; font-style: italic; }
        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #444; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #d1d9e6; border-radius: 8px; box-sizing: border-box; font-size: 15px; transition: 0.3s; }
        
        /* Select2 Custom */
        .select2-container .select2-selection--single { height: 45px !important; border: 1px solid #d1d9e6 !important; border-radius: 8px !important; padding: 8px; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { top: 10px !important; }
        
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background-color: #007bff; color: white; box-shadow: 0 4px 10px rgba(0,123,255,0.3); }

        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; z-index: 10; display: none; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 0 0 8px 8px; }
        .suggestion-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .suggestion-item:hover { background-color: #f8f9fa; color: #007bff; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 999; display: flex; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .popup-card { background: white; padding: 30px; border-radius: 15px; max-width: 450px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.2); animation: popIn 0.3s ease-out; }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        .popup-icon { font-size: 50px; margin-bottom: 15px; display: block; }
        .popup-title { font-size: 20px; font-weight: 800; color: #2c3e50; margin: 0 0 10px; }
        .popup-text { font-size: 14px; color: #555; line-height: 1.6; margin-bottom: 25px; text-align: justify; }
        .popup-btn { background: #28a745; color: white; width: 100%; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: bold; border: none; cursor: pointer; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="welcomeScreen" class="overlay">
        <div class="popup-card">
            <span class="popup-icon">üõ°Ô∏è</span>
            <h3 class="popup-title">TH√îNG B√ÅO QUAN TR·ªåNG</h3>
            <div class="popup-text">
                Ch√†o m·ª´ng Qu√Ω CBNV C√¥ng ty <b>CI BAO</b>.<br><br>
                ·ª®ng d·ª•ng n√†y ƒë∆∞·ª£c x√¢y d·ª±ng nh·∫±m m·ª•c ƒë√≠ch thu th·∫≠p d·ªØ li·ªáu ƒë·ªÉ t√≠nh to√°n <b>Ki·ªÉm k√™ Kh√≠ nh√† k√≠nh (Ph·∫°m vi 3)</b>, ph·ª•c v·ª• c√¥ng t√°c b√°o c√°o S·ªü T√†i Nguy√™n & M√¥i Tr∆∞·ªùng theo quy ƒë·ªãnh c·ªßa Lu·∫≠t B·∫£o v·ªá M√¥i tr∆∞·ªùng.<br><br>
                <b>Cam k·∫øt b·∫£o m·∫≠t:</b> M·ªçi th√¥ng tin c√° nh√¢n v√† ƒë·ªãa ch·ªâ c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c m√£ h√≥a v√† ch·ªâ s·ª≠ d·ª•ng n·ªôi b·ªô cho m·ª•c ƒë√≠ch m√¥i tr∆∞·ªùng n√™u tr√™n.<br><br>
                <div style="background:#f0f0f0; padding:10px; border-radius:5px; font-size:13px; border-left:4px solid #007bff;">
                    <b>‚ÑπÔ∏è L∆∞u √Ω:</b><br>
                    N·∫øu b·∫°n ƒëi·ªÅn l·∫°i phi·∫øu n√†y, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t k·∫øt qu·∫£ m·ªõi nh·∫•t (ghi ƒë√® k·∫øt qu·∫£ c≈©).
                </div>
            </div>
            <button class="popup-btn" onclick="startSurvey()">T√îI ƒê√É HI·ªÇU V√Ä ƒê·ªíNG √ù</button>
        </div>
    </div>

    <div id="successScreen" class="overlay hidden">
        <div class="popup-card">
            <span class="popup-icon">üåø</span>
            <h3 class="popup-title" style="color:#28a745">C·∫¨P NH·∫¨T TH√ÄNH C√îNG!</h3>
            <p class="popup-text" style="text-align: center;">
                D·ªØ li·ªáu c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n.<br>
                C·∫£m ∆°n b·∫°n ƒë√£ ƒë√≥ng g√≥p cho m·ª•c ti√™u Xanh c·ªßa c√¥ng ty!
            </p>
            <button class="popup-btn" style="background:#007bff" onclick="location.reload()">ƒê√ìNG V√Ä QUAY L·∫†I</button>
        </div>
    </div>

    <div id="mainForm" class="container">
        <div class="company-header">
            <h1 class="company-name">C√îNG TY TNHH CI BAO</h1>
            <h2 class="form-title">PHI·∫æU THU TH·∫¨P TH√îNG TIN DI CHUY·ªÇN</h2>
            <p class="form-desc">(Ph·ª•c v·ª• Ki·ªÉm k√™ Kh√≠ nh√† k√≠nh - GHG Inventory)</p>
        </div>

        <div class="form-group">
            <label>üîç T√¨m ki·∫øm nh√¢n s·ª±:</label>
            <input type="text" id="searchInput" placeholder="Nh·∫≠p M√£ th·∫ª ho·∫∑c H·ªç t√™n..." autocomplete="off">
            <div class="suggestions" id="suggestionBox"></div>
        </div>

        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px dashed #ccc; margin-bottom: 20px;">
            <div class="form-group" style="margin-bottom: 10px;">
                <label style="font-size:12px;">M√£ Nh√¢n Vi√™n:</label>
                <input type="text" id="staffCode" readonly style="background-color: #e9ecef; font-weight:bold;">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label style="font-size:12px;">H·ªç T√™n:</label>
                <input type="text" id="fullName" readonly style="background-color: #e9ecef; font-weight:bold;">
            </div>
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

        <div class="form-group">
            <label>üõµ Ph∆∞∆°ng ti·ªán ƒëi l√†m ch√≠nh:</label>
            <select id="vehicleType">
                <option value="Xe m√°y (XƒÉng)">Xe m√°y (XƒÉng)</option>
                <option value="Xe m√°y (ƒêi·ªán)">Xe m√°y (ƒêi·ªán)</option>
                <option value="√î t√¥ (XƒÉng)">√î t√¥ (XƒÉng)</option>
                <option value="√î t√¥ (D·∫ßu)">√î t√¥ (D·∫ßu)</option>
                <option value="Xe ƒë∆∞a r∆∞·ªõc">Xe ƒë∆∞a r∆∞·ªõc c√¥ng ty</option>
            </select>
        </div>

        <div class="form-group">
            <label>üè† ƒê·ªãa ch·ªâ c∆∞ tr√∫ (Ch·ªçn th·ªß c√¥ng):</label>
            <select id="province" style="width: 100%"><option value="">-- T·ªânh/Th√†nh ph·ªë --</option></select>
            <div style="height: 10px;"></div>
            <select id="district" style="width: 100%"><option value="">-- Qu·∫≠n/Huy·ªán --</option></select>
            <div style="height: 10px;"></div>
            <select id="ward" style="width: 100%"><option value="">-- Ph∆∞·ªùng/X√£ --</option></select>
            
            <input type="text" id="detailAddress" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng, ·∫•p/th√¥n/t·ªï..." style="margin-top: 15px;">
            
            <label style="margin-top:15px; color:#d35400;">Qu√£ng ƒë∆∞·ªùng 1 chi·ªÅu (Km):</label>
            <input type="number" id="distanceKm" placeholder="Nh·∫≠p s·ªë Km ∆∞·ªõc l∆∞·ª£ng (VD: 5.5)" step="0.1" style="font-weight:bold;">
        </div>

        <button id="submitBtn" class="btn-primary" onclick="submitForm()">G·ª¨I TH√îNG TIN üöÄ</button>
    </div>

<script>
    function startSurvey() { document.getElementById('welcomeScreen').classList.add('hidden'); document.getElementById('mainForm').style.display = 'block'; }

    const SUPABASE_URL = 'https://gywuxyywloioxhbfybdl.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5d3V4eXl3bG9pb3hoYmZ5YmRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MTYyMDgsImV4cCI6MjA4Mjk5MjIwOH0.oCRTqibMzqfsGdaDkZ53inAoNR56QWDHQ3fWtmRqfIk';
    const { createClient } = window.supabase;
    const dbClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- C·∫§U H√åNH T√åM KI·∫æM T·ªàNH TH√ÄNH (SELECT2) ---
    $(document).ready(function() {
        $('#province').select2({ placeholder: "-- T√¨m T·ªânh/Th√†nh ph·ªë --" });
        $('#district').select2({ placeholder: "-- T√¨m Qu·∫≠n/Huy·ªán --" });
        $('#ward').select2({ placeholder: "-- T√¨m Ph∆∞·ªùng/X√£ --" });
        $('#province').on('select2:select', function (e) { loadDistricts(); });
        $('#district').on('select2:select', function (e) { loadWards(); });
    });

    // --- T√åM KI·∫æM NH√ÇN VI√äN ---
    const searchInput = document.getElementById('searchInput');
    const suggestionBox = document.getElementById('suggestionBox');
    searchInput.addEventListener('input', async (e) => {
        const keyword = e.target.value.trim();
        if (keyword.length < 2) { suggestionBox.style.display = 'none'; return; }
        const { data } = await dbClient.from('employees').select('*').or(`staff_code.ilike.%${keyword}%,full_name.ilike.%${keyword}%`).limit(5);
        if (data && data.length > 0) {
            suggestionBox.innerHTML = ''; suggestionBox.style.display = 'block';
            data.forEach(emp => {
                const div = document.createElement('div'); div.className = 'suggestion-item';
                div.textContent = `${emp.staff_code} - ${emp.full_name}`;
                div.onclick = () => { document.getElementById('staffCode').value = emp.staff_code; document.getElementById('fullName').value = emp.full_name; searchInput.value = ''; suggestionBox.style.display = 'none'; };
                suggestionBox.appendChild(div);
            });
        } else { suggestionBox.style.display = 'none'; }
    });

    // --- DATA H√ÄNH CH√çNH ---
    const host = "https://provinces.open-api.vn/api/";
    fetch(host + "?depth=1").then(r=>r.json()).then(d=>{ 
        let h='<option value="">-- T·ªânh/Th√†nh ph·ªë --</option>'; 
        d.forEach(p=>h+=`<option value="${p.code}">${p.name}</option>`); 
        document.getElementById('province').innerHTML = h; 
    });
    window.loadDistricts = function() { 
        fetch(host + "p/" + document.getElementById('province').value + "?depth=2").then(r=>r.json()).then(d=>{ 
            let h='<option value="">-- Qu·∫≠n/Huy·ªán --</option>'; 
            d.districts.forEach(k=>h+=`<option value="${k.code}">${k.name}</option>`); 
            document.getElementById('district').innerHTML = h;
            $('#district').val(null).trigger('change');
        }); 
    }
    window.loadWards = function() { 
        fetch(host + "d/" + document.getElementById('district').value + "?depth=2").then(r=>r.json()).then(d=>{ 
            let h='<option value="">-- Ph∆∞·ªùng/X√£ --</option>'; 
            d.wards.forEach(w=>h+=`<option value="${w.code}">${w.name}</option>`); 
            document.getElementById('ward').innerHTML = h;
            $('#ward').val(null).trigger('change');
        }); 
    }

    // --- G·ª¨I FORM (C∆† CH·∫æ: C√ì R·ªíI TH√å UPDATE, CH∆ØA C√ì TH√å INSERT) ---
    window.submitForm = async function() {
        const staffCode = document.getElementById('staffCode').value;
        const fullName = document.getElementById('fullName').value;
        const vehicle = document.getElementById('vehicleType').value;
        const dist = parseFloat(document.getElementById('distanceKm').value);
        const detail = document.getElementById('detailAddress').value;
        
        // Validation
        const p = document.getElementById('province');
        const d = document.getElementById('district');
        const w = document.getElementById('ward');
        if (!staffCode) return alert("Vui l√≤ng ch·ªçn nh√¢n vi√™n!");
        if (isNaN(dist) || dist <= 0) return alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë Km (∆∞·ªõc l∆∞·ª£ng t·ª´ nh√† ƒë·∫øn c√¥ng ty)!");
        if (!p.value || !d.value || !w.value || !detail) return alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ƒë·ªãa ch·ªâ!");

        const pText = p.options[p.selectedIndex].text;
        const dText = d.options[d.selectedIndex].text;
        const wText = w.options[w.selectedIndex].text;
        const fullAddress = `${detail}, ${wText}, ${dText}, ${pText}`;

        const btn = document.getElementById('submitBtn');
        btn.innerText = "ƒêANG G·ª¨I...";
        btn.disabled = true;

        // B∆Ø·ªöC 1: KI·ªÇM TRA ƒê√É C√ì CH∆ØA
        const { data: existingData } = await dbClient.from('emissions').select('id').eq('staff_code', staffCode);
        
        let error = null;
        if (existingData && existingData.length > 0) {
            // C√ì R·ªíI -> GHI ƒê√à (UPDATE)
            const idToUpdate = existingData[0].id;
            const { error: updateErr } = await dbClient.from('emissions').update({
                full_name: fullName,
                vehicle_type: vehicle,
                address_string: fullAddress,
                distance_km: dist,
                working_days: 0, // Reset ng√†y c√¥ng
                co2_total_kg: 0
            }).eq('id', idToUpdate);
            error = updateErr;
        } else {
            // CH∆ØA C√ì -> TH√äM M·ªöI (INSERT)
            const { error: insertErr } = await dbClient.from('emissions').insert({
                staff_code: staffCode,
                full_name: fullName,
                vehicle_type: vehicle,
                address_string: fullAddress,
                distance_km: dist,
                working_days: 0,
                co2_total_kg: 0
            });
            error = insertErr;
        }

        if (error) {
            alert("L·ªói: " + error.message);
            btn.innerText = "G·ª¨I TH√îNG TIN üöÄ";
            btn.disabled = false;
        } else {
            document.getElementById('mainForm').style.display = 'none';
            document.getElementById('successScreen').classList.remove('hidden');
        }
    }
</script>
</body>
</html>