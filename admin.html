<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n L√Ω Ph√°t Th·∫£i - CI BAO Company</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* CSS CHUNG */
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        #loginScreen { max-width: 400px; margin: 100px auto; text-align: center; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; }
        .btn { padding: 10px 15px; cursor: pointer; border: none; border-radius: 6px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .btn-blue { background: #007bff; color: white; }
        .btn-green { background: #28a745; color: white; }
        .btn-red { background: #dc3545; color: white; }
        .btn-gray { background: #6c757d; color: white; }
        .btn-orange { background: #e67e22; color: white; }

        /* HEADER & KPI */
        .report-header { text-align: center; border-bottom: 3px double #ddd; padding-bottom: 10px; margin-bottom: 20px; }
        .kpi-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .kpi-card { flex: 1; background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e9ecef; }
        .kpi-val { font-size: 24px; font-weight: bold; display: block; margin-top: 5px; }
        
        /* CHARTS */
        .charts-row { display: flex; gap: 20px; margin-bottom: 10px; height: 300px; }
        .chart-box { flex: 1; border: 1px solid #eee; padding: 10px; border-radius: 8px; position: relative; page-break-inside: avoid; }
        
        /* B·∫¢NG */
        #detailSection { display: none; margin-top: 20px; border-top: 2px solid #007bff; padding-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #dee2e6; padding: 8px; text-align: left; }
        th { background-color: #e9ecef; }

        /* TOOLS */
        .admin-section { margin-top: 30px; border: 2px dashed #b0b0b0; padding: 20px; background: #fffdf0; border-radius: 8px; }
        .admin-header { font-weight: bold; color: #d35400; margin-bottom: 15px; text-transform: uppercase; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .tool-box { display: flex; gap: 20px; flex-wrap: wrap; }
        .tool-card { flex: 1; min-width: 250px; background: white; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
        .tool-desc { font-size: 12px; color: #666; margin-bottom: 10px; display: block; }

        /* IN ·∫§N */
        @media print { .chart-box, tr { break-inside: avoid; } }
    </style>
</head>
<body>

    <div id="loginScreen">
        <h2 style="color:#007bff">üîê CI BAO ADMIN</h2>
        <input type="email" id="email" placeholder="Email Admin">
        <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
        <button class="btn btn-blue" onclick="login()" style="width:100%">ƒêƒÉng Nh·∫≠p</button>
        <p id="loginMsg" style="color:red; margin-top:10px"></p>
    </div>

    <div id="dashboard" style="display:none">
        <div id="print-area" class="container">
            <div class="report-header">
                <h1 style="margin:0; color:#2c3e50; font-size: 22px;">C√îNG TY TNHH CI BAO</h1>
                <p style="font-style:italic; color:#555; margin: 5px 0;">ƒê∆∞·ªùng N5, KCN Su·ªëi Tre, P. B√¨nh L·ªôc, T·ªânh ƒê·ªìng Nai</p>
                <div style="color:#007bff; font-weight:bold; font-size:18px; margin-top:10px;">B√ÅO C√ÅO KI·ªÇM K√ä KH√ç NH√Ä K√çNH</div>
                <small>Ng√†y b√°o c√°o: <span id="reportDate"></span></small>
            </div>

            <div class="kpi-row">
                <div class="kpi-card">
                    <small>S·ªê L∆Ø·ª¢NG KH·∫¢O S√ÅT</small>
                    <span class="kpi-val" id="kpi-users" style="color:#2c3e50">0</span>
                    <small id="progress-text" style="color:blue">...</small>
                </div>
                <div class="kpi-card">
                    <small>T·ªîNG QU√ÉNG ƒê∆Ø·ªúNG (KM)</small>
                    <span class="kpi-val" id="kpi-km" style="color:#2980b9">0</span>
                </div>
                <div class="kpi-card">
                    <small>T·ªîNG PH√ÅT TH·∫¢I (T·∫§N CO2e)</small>
                    <span class="kpi-val" id="kpi-co2" style="color:#c0392b">0</span>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-box"><canvas id="vehicleChart"></canvas></div>
                <div class="chart-box"><canvas id="emissionChart"></canvas></div>
            </div>

            <div id="detailSection">
                <div class="html2pdf__page-break"></div>
                <h3>PH·ª§ L·ª§C: DANH S√ÅCH CHI TI·∫æT</h3>
                <table id="dataTable">
                    <thead><tr><th>M√£ NV</th><th>H·ªç T√™n</th><th>Ph∆∞∆°ng ti·ªán</th><th>ƒê·ªãa ch·ªâ</th><th>Km/ng√†y (2 chi·ªÅu)</th><th>Ng√†y c√¥ng</th><th>kgCO2e</th></tr></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="container" style="margin-top: 20px; background: #e9ecef; padding: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-orange" onclick="loadData()">üîÑ L√†m m·ªõi d·ªØ li·ªáu</button>
                    <button id="toggleBtn" class="btn btn-gray" onclick="toggleDetails()">üîΩ Xem danh s√°ch</button>
                    <div style="border-left:1px solid #ccc; padding-left:10px; display:flex; gap:5px; align-items:center;">
                        <strong>C·∫≠p nh·∫≠t c√¥ng:</strong>
                        <input type="file" id="uploadFile" accept=".xlsx, .csv" style="font-size:12px;">
                        <button class="btn btn-blue" onclick="processUpload()">‚¨ÜÔ∏è X·ª≠ l√Ω</button>
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-green" onclick="exportExcel()">üìä Excel</button>
                    <button class="btn btn-red" onclick="exportPDF()">üìÑ PDF</button>
                    <button class="btn btn-gray" onclick="logout()">Tho√°t</button>
                </div>
            </div>
            <div id="statusLog" style="margin-top:10px; color:blue;"></div>

            <div class="admin-section">
                <div class="admin-header">üõ†Ô∏è C√îNG C·ª§ QU·∫¢N TR·ªä H·ªÜ TH·ªêNG</div>
                
                <div style="background: white; padding: 15px; border-radius: 6px; border: 2px solid #007bff; margin-bottom: 20px;">
                    <strong style="color:#007bff; display:block; margin-bottom:10px;">üïí C√ÄI ƒê·∫∂T TH·ªúI GIAN KH·∫¢O S√ÅT (T·ª± ƒë·ªông kh√≥a khi h·∫øt h·∫°n)</strong>
                    <div style="display:flex; gap:20px; align-items:flex-end;">
                        <div style="flex:1">
                            <label style="font-size:12px; font-weight:bold;">Th·ªùi gian M·ªü:</label>
                            <input type="datetime-local" id="startTime" style="width:100%">
                        </div>
                        <div style="flex:1">
                            <label style="font-size:12px; font-weight:bold;">Th·ªùi gian ƒê√≥ng:</label>
                            <input type="datetime-local" id="endTime" style="width:100%">
                        </div>
                        <button class="btn btn-blue" onclick="saveConfig()">üíæ L∆∞u C·∫•u H√¨nh</button>
                    </div>
                </div>

                <div class="tool-box">
                    <div class="tool-card">
                        <strong>1. Ki·ªÉm tra Ti·∫øn ƒë·ªô</strong><br>
                        <span class="tool-desc">Xem ai ch∆∞a l√†m kh·∫£o s√°t.</span>
                        <button class="btn btn-blue" style="width:100%" onclick="checkMissing()">üïµÔ∏è T√¨m ng∆∞·ªùi ch∆∞a n·ªôp</button>
                    </div>
                    <div class="tool-card">
                        <strong>2. Reset d·ªØ li·ªáu</strong><br>
                        <span class="tool-desc">X√≥a k·∫øt qu·∫£ c≈© (6 th√°ng/l·∫ßn).</span>
                        <button class="btn btn-red" style="width:100%" onclick="resetData()">üóëÔ∏è X√≥a k·∫øt qu·∫£</button>
                    </div>
                    <div class="tool-card">
                        <strong>3. C·∫≠p nh·∫≠t Nh√¢n vi√™n</strong><br>
                        <span class="tool-desc">Thay th·∫ø danh s√°ch nh√¢n vi√™n m·ªõi.</span>
                        <input type="file" id="newEmpFile" style="font-size:11px; margin-bottom:5px;">
                        <button class="btn btn-green" style="width:100%" onclick="uploadEmployees()">üë• N·∫°p DS M·ªõi</button>
                    </div>
                </div>
                <div id="adminLog" style="margin-top:10px; font-weight:bold; color:#d35400;"></div>
            </div>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://gywuxyywloioxhbfybdl.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5d3V4eXl3bG9pb3hoYmZ5YmRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MTYyMDgsImV4cCI6MjA4Mjk5MjIwOH0.oCRTqibMzqfsGdaDkZ53inAoNR56QWDHQ3fWtmRqfIk';
    const { createClient } = window.supabase;
    const adminClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    let globalData = [];
    let vehicleChartInstance = null;
    let emissionChartInstance = null;
    let totalEmpCount = 0;

    document.getElementById('reportDate').innerText = new Date().toLocaleDateString('vi-VN');

    async function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const msg = document.getElementById('loginMsg');
        msg.innerText = "ƒêang k·∫øt n·ªëi...";
        const { error } = await adminClient.auth.signInWithPassword({ email, password });
        if (error) msg.innerText = "L·ªói: " + error.message;
        else {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadData();
            loadConfig(); // T·∫£i gi·ªù gi·∫•c
        }
    }
    async function logout() { await adminClient.auth.signOut(); location.reload(); }

    async function loadData() {
        const { data, error } = await adminClient.from('emissions').select('*').range(0, 19999).order('full_name', { ascending: true });
        if (error) return alert("L·ªói t·∫£i d·ªØ li·ªáu!");
        const { count } = await adminClient.from('employees').select('*', { count: 'exact', head: true });
        totalEmpCount = count || 0;
        globalData = data;
        renderKPI(data); renderCharts(data); renderTable(data);
    }

    // --- C√ÅC H√ÄM X·ª¨ L√ù C·∫§U H√åNH (M·ªöI) ---
    async function loadConfig() {
        const { data } = await adminClient.from('app_config').select('*');
        if(data) {
            data.forEach(item => {
                if(item.key === 'survey_start') document.getElementById('startTime').value = item.value;
                if(item.key === 'survey_end') document.getElementById('endTime').value = item.value;
            });
        }
    }

    async function saveConfig() {
        const start = document.getElementById('startTime').value;
        const end = document.getElementById('endTime').value;
        if(!start || !end) return alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß th·ªùi gian!");
        
        // Upsert t·ª´ng d√≤ng
        await adminClient.from('app_config').upsert({ key: 'survey_start', value: start });
        await adminClient.from('app_config').upsert({ key: 'survey_end', value: end });
        
        alert("‚úÖ ƒê√£ l∆∞u c·∫•u h√¨nh th·ªùi gian th√†nh c√¥ng!");
    }

    // --- C√ÅC H√ÄM C≈® (GI·ªÆ NGUY√äN) ---
    function renderKPI(data) {
        document.getElementById('kpi-users').innerText = data.length.toLocaleString('vi-VN');
        document.getElementById('progress-text').innerText = `Ti·∫øn ƒë·ªô: ${data.length.toLocaleString('vi-VN')} / ${totalEmpCount.toLocaleString('vi-VN')} NV`;
        const totalKm = data.reduce((sum, item) => sum + (item.distance_km * 2 * (item.working_days || 0)), 0);
        document.getElementById('kpi-km').innerText = Math.round(totalKm).toLocaleString('vi-VN');
        const totalKg = data.reduce((sum, item) => sum + (item.co2_total_kg || 0), 0);
        document.getElementById('kpi-co2').innerText = (totalKg / 1000).toFixed(3);
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
        data.forEach(row => {
            const tr = document.createElement('tr');
            let shortAddr = row.address_string || "";
            if (shortAddr.length > 50) shortAddr = shortAddr.substring(0, 50) + "...";
            let dist2Way = (row.distance_km * 2).toFixed(1);
            if(row.distance_km === 0) dist2Way = `<span style="color:red">0 (S·ª≠a)</span>`;
            tr.innerHTML = `<td>${row.staff_code}</td><td><strong>${row.full_name}</strong></td><td>${row.vehicle_type}</td><td title="${row.address_string}">${shortAddr}</td><td>${dist2Way}</td><td>${row.working_days}</td><td>${(row.co2_total_kg||0).toFixed(1)}</td>`;
            tbody.appendChild(tr);
        });
    }

    function renderCharts(data) {
        const vehicles = {}; const co2ByVehicle = {};
        data.forEach(item => { const v = item.vehicle_type; vehicles[v] = (vehicles[v] || 0) + 1; co2ByVehicle[v] = (co2ByVehicle[v] || 0) + (item.co2_total_kg || 0); });
        
        const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true } } };
        if(vehicleChartInstance) vehicleChartInstance.destroy();
        const ctx1 = document.getElementById('vehicleChart').getContext('2d');
        vehicleChartInstance = new Chart(ctx1, {type:'doughnut', data:{labels:Object.keys(vehicles), datasets:[{data:Object.values(vehicles), backgroundColor:['#007bff','#dc3545','#28a745','#ffc107','#17a2b8']}]}, options: {...chartOptions, plugins: {title: {display: true, text: 'C∆† C·∫§U PH∆Ø∆†NG TI·ªÜN'}}}});
        if(emissionChartInstance) emissionChartInstance.destroy();
        const ctx2 = document.getElementById('emissionChart').getContext('2d');
        emissionChartInstance = new Chart(ctx2, {type:'bar', data:{labels:Object.keys(co2ByVehicle), datasets:[{label:'kgCO2e', data:Object.values(co2ByVehicle), backgroundColor:'#dc3545'}]}, options: {...chartOptions, plugins: {title: {display: true, text: 'PH√ÅT TH·∫¢I (KG)'}}}});
    }

    function toggleDetails() { const s = document.getElementById('detailSection'); const b = document.getElementById('toggleBtn'); if (s.style.display === 'none') { s.style.display = 'block'; b.innerText = 'üîº Thu g·ªçn'; b.className = "btn btn-blue"; } else { s.style.display = 'none'; b.innerText = 'üîΩ Xem danh s√°ch'; b.className = "btn btn-gray"; } }

    function exportPDF() {
        const element = document.getElementById('print-area');
        const s = document.getElementById('detailSection');
        const wasHidden = (s.style.display === 'none');
        if (wasHidden) s.style.display = 'block';
        alert("ƒêang t·∫°o PDF... Vui l√≤ng ch·ªù.");
        const opt = {
            margin: [0.3, 0.3, 0.3, 0.3], filename: 'BaoCao_KiemKe_CIBAO.pdf', image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };
        html2pdf().set(opt).from(element).save().then(() => { if(wasHidden) s.style.display='none'; });
    }

    function exportExcel() { const ws = XLSX.utils.json_to_sheet(globalData.map(i => ({"M√£ NV": i.staff_code, "H·ªç T√™n": i.full_name, "Ph∆∞∆°ng ti·ªán": i.vehicle_type, "ƒê·ªãa ch·ªâ": i.address_string, "Km (1 chi·ªÅu)": i.distance_km, "Km (2 chi·ªÅu)": i.distance_km*2, "Ng√†y c√¥ng": i.working_days, "T·ªïng CO2 (kg)": i.co2_total_kg}))); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "DS_PhatThai"); XLSX.writeFile(wb, "BaoCao_CIBAO_Full.xlsx"); }
    function processUpload() { const f = document.getElementById('uploadFile'); if (!f.files[0]) return alert("Ch∆∞a ch·ªçn file!"); const r = new FileReader(); r.onload = function(e) { const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'}); updateAndCalculate(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]])); }; r.readAsArrayBuffer(f.files[0]); }
    
    async function updateAndCalculate(rows) {
        document.getElementById('statusLog').innerText = "ƒêang x·ª≠ l√Ω...";
        const map = {};
        rows.forEach(r => { let c = String(r['MaNV']||r['MANV']||r['MaThe']||r['ma_nv']).trim(); if(/^\d+$/.test(c)) c = c.padStart(5,'0'); map[c] = r['NgayCong']||r['NGAYCONG']||0; });
        const {data} = await adminClient.from('emissions').select('*').range(0, 19999);
        let count = 0;
        for(let i of data) {
            let c = String(i.staff_code).trim(); if(/^\d+$/.test(c)) c = c.padStart(5,'0');
            if(map[c] > 0) {
                let ef = 0.08;
                if(i.vehicle_type.includes("ƒêi·ªán")) ef = 0.03; else if(i.vehicle_type.includes("√î t√¥") && i.vehicle_type.includes("XƒÉng")) ef = 0.17; else if(i.vehicle_type.includes("√î t√¥") && i.vehicle_type.includes("D·∫ßu")) ef = 0.17; else if(i.vehicle_type.includes("ƒë∆∞a r∆∞·ªõc")) ef = 0;
                await adminClient.from('emissions').update({ working_days: map[c], co2_total_kg: i.distance_km * 2 * map[c] * ef }).eq('id', i.id);
                count++;
            }
        }
        alert(`‚úÖ C·∫≠p nh·∫≠t xong cho ${count} ng∆∞·ªùi.`); document.getElementById('statusLog').innerText = ""; loadData();
    }

    async function resetData() { if(!confirm("C·∫¢NH B√ÅO: X√≥a s·∫°ch d·ªØ li·ªáu?")) return; document.getElementById('adminLog').innerText="ƒêang x√≥a..."; await adminClient.from('emissions').delete().neq('id', 0); alert("ƒê√£ x√≥a d·ªØ li·ªáu."); loadData(); document.getElementById('adminLog').innerText=""; }
    
    async function uploadEmployees() {
        const f = document.getElementById('newEmpFile'); if (!f.files[0]) return alert("Ch∆∞a ch·ªçn file!"); if(!confirm("X√≥a danh s√°ch NV c≈© v√† thay m·ªõi?")) return;
        document.getElementById('adminLog').innerText="ƒêang x·ª≠ l√Ω...";
        const r = new FileReader();
        r.onload = async function(e) {
            const rows = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type:'array'}).Sheets[XLSX.read(new Uint8Array(e.target.result),{type:'array'}).SheetNames[0]]);
            await adminClient.from('employees').delete().neq('id', 0);
            const CHUNK = 1000;
            let successCount = 0;
            for (let i=0; i<rows.length; i+=CHUNK) {
                const chunk = rows.slice(i, i+CHUNK).map(r => ({ staff_code: String(r['staff_code']||r['MaNV']).trim().padStart(5,'0'), full_name: r['full_name']||r['HoTen'] })).filter(x => x.staff_code && x.full_name);
                await adminClient.from('employees').insert(chunk);
                successCount += chunk.length;
                document.getElementById('adminLog').innerText = `ƒêang n·∫°p ${Math.min(i + CHUNK, rows.length)}/${rows.length}...`;
            }
            alert(`‚úÖ ƒê√£ n·∫°p th√†nh c√¥ng ${successCount} nh√¢n vi√™n!`); 
            document.getElementById('adminLog').innerText=""; loadData();
        };
        r.readAsArrayBuffer(f.files[0]);
    }

    async function checkMissing() {
        document.getElementById('adminLog').innerText="ƒêang d√≤...";
        const { data: allEmp } = await adminClient.from('employees').select('staff_code, full_name').range(0, 19999);
        const submitted = new Set(globalData.map(i => String(i.staff_code).trim()));
        const missing = allEmp.filter(e => { let c = String(e.staff_code).trim(); if(/^\d+$/.test(c)) c = c.padStart(5,'0'); return !submitted.has(c); });
        document.getElementById('adminLog').innerText="";
        if(missing.length > 0 && confirm(`C√≥ ${missing.length} ng∆∞·ªùi ch∆∞a n·ªôp. T·∫£i Excel?`)) {
            const ws = XLSX.utils.json_to_sheet(missing); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ChuaNop"); XLSX.writeFile(wb, "DS_ChuaNop.xlsx");
        } else alert("ƒê√£ n·ªôp ƒë·ªß!");
    }
</script>
</body>
</html>